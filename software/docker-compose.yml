version: '2'

services:
    api_container:
        build: 
            context: ./containers/telescope_web_api
        volumes:
            -   data-volume:/telescope_data
            -   ~/tart_web_api_store:/app
#        devices:
#            - /dev/spidev0.0
        environment:
            # Change the following to be something secure. You will use this to login to your telescope from the web api.
            - LOGIN_PW=passwd
        ports:
            - 5000:5000
        restart: always
        logging:
            driver: "json-file"
            options:
                max-file: "5"
                max-size: "10m"

    api_doc_server:
        build:
            context: ./containers/telescope_web_api
            dockerfile: Dockerfile.apidoc 
        ports: 
            - 8080:80

    web_app:
        depends_on:
            - api_container
            - api_doc_server
        volumes:
            -   data-volume:/telescope_data
        build: 
            context: ./containers/web_app
            args:
                # Change this if you desire. Really only needed for running multiple TART telescopes and reverse proxying.
                tart_name: dev
        ports: 
            - 80:80
        restart: always
        logging:
            driver: "json-file"
            options:
                max-file: "5"
                max-size: "10m"

    http-tunnel:
        depends_on:
            - web_app
        build: 
            context: ./containers/autossh
        environment:
            - SSH_HOSTUSER=tart
            - SSH_HOSTNAME=tart.elec.ac.nz
            - SSH_TUNNEL_REMOTE=8002
            - SSH_TUNNEL_LOCAL=80
            - SSH_TUNNEL_HOST=web_app
        restart: always
        volumes:
            - ~/.ssh/id_rsa:/id_rsa


volumes:
    # Mounted on each container as /telescope_data, used for raw data and vis data. This is a hardcoded path in each container.
    data-volume:
    
